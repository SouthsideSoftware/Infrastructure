<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" DefaultTargets ="Dist" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <!-- See https://onpointondemand.fogbugz.com/default.asp?W695 for documentation -->
	<!-- Tools -->
	<PropertyGroup>
		<ToolsDir>$(MSBuildProjectDirectory)\tools</ToolsDir>
		<PackageDir>$(MSBuildProjectDirectory)\packages</PackageDir>
		<MSBuildCommunityTasksPath>$(ToolsDir)\MSBuild\MSBuildCommunityTasks</MSBuildCommunityTasksPath>
		<SouthSideTasksPath>$(ToolsDir)\MSBuild\SouthSideBuildTasks</SouthSideTasksPath>
		<NuGet>$(ToolsDir)\nuget.exe</NuGet>
	</PropertyGroup>

	<!-- Artifact Directories -->
	<PropertyGroup>
		<OutputDir>$(MSBuildProjectDirectory)\BuildOutput</OutputDir>
		<BinDir>$(OutputDir)\bin</BinDir>
		<DistributionDir>$(OutputDir)\distribution</DistributionDir>
		<HelpDir>$(OutputDir)\Help</HelpDir>
		<TestOutputDir>$(OutputDir)\TestResults</TestOutputDir>
	</PropertyGroup>

	<!-- General Build Configuration Properties -->
	<PropertyGroup>
		<ProductName>[ExampleProductName]</ProductName>
		<ProductDescription>[Example Description]</ProductDescription>
		<Configuration>Debug</Configuration>
		<GenerateDocs>false</GenerateDocs>
	</PropertyGroup>

	<!-- Version Information -->
	<PropertyGroup>
		<AppVersion>0.1.0</AppVersion>
		<SchemaVersion>0</SchemaVersion>
		<InTeamCity Condition="'$(build_number)' == ''">false</InTeamCity>
		<InTeamCity Condition="'$(build_number)' != ''">true</InTeamCity>
		<BuildNumber Condition="!$(InTeamCity)">0</BuildNumber>
		<BuildNumber Condition="$(InTeamCity)">$(build_number)</BuildNumber>
		<CompanyName>Onpoint On Demand</CompanyName>
	</PropertyGroup>

	<!-- Misc -->
	<PropertyGroup>
		<ZipQualifier>_$(AppVersion).$(BuildNumber)_$(Configuration).zip</ZipQualifier>
	</PropertyGroup>
 
	<ItemGroup>
		<ProjectToBuild Include="$(MSBuildProjectDirectory)\$(ProductName).sln"></ProjectToBuild>
	</ItemGroup>

	<Import Project="$(MSBuildCommunityTasksPath)\MSBuild.Community.Tasks.Targets"/>
	<Import Project="$(SouthSideTasksPath)\SouthSideBuildTasks.MSBuild.Tasks.Targets"/>

	<Target Name="Dist" DependsOnTargets="Clean;InstallPackages;Version;Build;Test;Publish"/>
  <Target Name="TeamCityBuild" DependsOnTargets="Clean;InstallPackages;Version;Build;BuildMSpecBat"/>
  <Target Name="TeamCityPublish" DependsOnTargets="Document;Publish"/>
  
	<Target Name="Clean">
    <Message Importance="high" Text="Clean"/>
		<Message Importance="high" Text="======================================================="/>
		<Message Importance="high" Text="Configuration = $(Configuration)"/>
		<Message Importance="high" Text="Version = $(AppVersion).$(BuildNumber)"/>
    <Message Importance="high" Text="DB = $(SchemaVersion)"/>
    <Message Importance="high" Text="MSBuild Path: $(MSBuildBinPath)"/>
		<Message Importance="high" Text="======================================================="/>
    <RemoveDir Directories="$(OutputDir)" ContinueOnError="true"/>
		<MakeDir Directories="$(OutputDir)"/>
		<MakeDir Directories="$(BinDir)"/>
		<MakeDir Directories="$(DistributionDir)"/>
		<MakeDir Directories="$(HelpDir)"/>
    <MakeDir Directories="$(TestOutputDir)"/>
	</Target>

  <Target Name="InstallPackages">
    <Message Importance="high" Text="Installing packages for solution"/>
    <XmlQuery XmlFileName="$(PackageDir)\repositories.config" XPath="//repositories/*">
      <Output TaskParameter="Values" ItemName="Values"/>
    </XmlQuery>
    <ItemGroup>
      <ProjectWithPackages Include="%(Values.path)"/>
    </ItemGroup>
    <Exec WorkingDirectory="$(PackageDir)" Command="$(NuGet) install %(ProjectWithPackages.Identity) -o $(MSBuildProjectDirectory)\packages"/>
  </Target>
  
	<Target Name="Version">
		<Message Importance="high" Text="Version"/>
		<Time>
			<Output TaskParameter="Year" PropertyName="Year"/>
		</Time>
		<AssemblyInfo OutputFile="$(MSBuildProjectDirectory)\src\CommonAssemblyInfo.cs" CodeLanguage="C#"
					  ComVisible="false" AssemblyCulture=""
					  AssemblyVersion="$(AppVersion)"
					  AssemblyFileVersion="$(AppVersion).$(BuildNumber)"
					  AssemblyCopyright="Copyright ï¿½ $(CompanyName) $(Year)"
					  AssemblyConfiguration="$(Configuration)"
					  AssemblyCompany="$(CompanyName)"
					  AssemblyProduct="$(ProductDescription) ($(Configuration) DB: $(SchemaVersion))"/>
  </Target>

	<Target Name="Build">
		<Message Importance="high" Text="Build"/>
    <Time>
      <Output TaskParameter="Ticks" PropertyName="StartTick"/>
    </Time>
     <MSBuild Projects="@(ProjectToBuild)"
				 Targets="Rebuild"
				 Properties="Configuration=$(Configuration);Platform=Any CPU"/>
    <Time>
      <Output TaskParameter="Ticks" PropertyName="EndTick"/>
    </Time>
    <Math.Subtract Numbers="$(EndTick);$(StartTick)">
      <Output TaskParameter="Result" PropertyName="ElapsedTicks" />
    </Math.Subtract>
    <Math.Divide Numbers="$(ElapsedTicks);10000000.0">
      <Output TaskParameter="Result" PropertyName="ElapsedSeconds" />
    </Math.Divide>


    <Message Importance="high" Text="Compile Seconds: $(ElapsedSeconds)"/>
  </Target>

	<Target Name="Test">
		<Message Importance="high" Text="Test"/>
    <CallTarget Targets="MSpecTests;NUnitTests"/>
	</Target>

  <Target Name="MSpecTests" Outputs="%(MSpecTestItem.Identity)">
    <Message Importance="high" Text="Testing: %(MSpecTestItem.TestDir)\%(MSpecTestItem.Identity)"/>
    <PropertyGroup>
      <TestProjectDir>$(MSBuildProjectDirectory)\src\Tests\%(MSpecTestItem.Identity)</TestProjectDir>
      <TestDir>$(TestProjectDir)\bin\$(Configuration)</TestDir>
    </PropertyGroup>
    
    <Message Importance="high" Text="Testing: $(TestDir)\%(MSpecTestItem.Identity)"/>

    <XmlRead XPath="//package[@id='Machine.Specifications']/@version"
             XmlFileName="$(TestProjectDir)\packages.config">
      <Output TaskParameter="Value" PropertyName="MSpecVersion"/>
    </XmlRead>
    <Message Importance="high" Text="MSpec Path: $(PackageDir)\Machine.Specifications.$(MSpecVersion)\tools\mspec-clr4.exe"/>
    <ItemGroup>
      <Tokens Include="mspecTestRunner">
        <ReplacementValue>$(PackageDir)\Machine.Specifications.$(MSpecVersion)\tools\mspec-clr4.exe</ReplacementValue>
      </Tokens>
    </ItemGroup>
    <TemplateFile Template="$(MSBuildProjectDirectory)\tools\MSBuild\BuildSupport\mspecTemplate.bat" OutputFileName="$(MSBuildProjectDirectory)\mspec.bat" Tokens="@(Tokens)"/>
    
    <Exec WorkingDirectory="$(TestDir)"
          Command="$(MsBuildProjectDirectory)\mspec --html $(TestOutputDir)\%(MSpecTestItem.Identity).results.htm %(MSpecTestItem.Identity).dll"/>
  </Target>

  <Target Name="NUnitTests" Outputs="%(NUnitTestItem.Identity)">
    <PropertyGroup>
      <TestProjectDir>$(MSBuildProjectDirectory)\src\Tests\%(NUnitTestItem.Identity)</TestProjectDir>
      <TestDir>$(TestProjectDir)\bin\$(Configuration)</TestDir>
    </PropertyGroup>
    
    <Message Importance="high" Text="Testing in NUnit: $(TestDir)\%(NUnitTestItem.Identity)"/>
    
    <XmlRead XPath="//package[@id='NUnit']/@version"
             XmlFileName="$(TestProjectDir)\packages.config">
      <Output TaskParameter="Value" PropertyName="NUnitVersion"/>
    </XmlRead>

    <Message Importance="high" Text="NUnit: $(PackageDir)\Nunit.$(NUnitVersion)\tools\nunit-console.exe"/>

    <Exec WorkingDirectory="$(TestDir)"
          Command='"$(PackageDir)\NUnit.$(NUnitVersion)\tools\nunit-console.exe" %(NUnitTestItem.Identity).dll /xml=$(TestOutputDir)\%(NUnitTestItem.Identity).results.nunit.xml"'/>
  </Target>

	<Target Name="Publish">
		<Message Importance="high" Text="Publish"/>
    
    <Copy SourceFiles="@(BinFiles)" DestinationFolder="$(BinDir)"/>
    
    <ItemGroup>
      <ZipFiles Include="$(BinDir)\**\*.*"/>
    </ItemGroup>
    <PropertyGroup>
      <ZipFileName>$(DistributionDir)\$(ProductName)$(ZipQualifier)</ZipFileName>
    </PropertyGroup>
    <Zip Files="@(ZipFiles)" WorkingDirectory="$(BinDir)" ZipFileName="$(ZipFileName)"/>
	</Target>
</Project>
